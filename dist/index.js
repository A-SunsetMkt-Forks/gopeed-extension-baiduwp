(()=>{"use strict";var t=gopeed;function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}async function r(t,r,n){var i=[];return await async function r(o,a){var s,c=function(t,r){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=function(t,r){if(t){if("string"==typeof t)return e(t,r);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,r):void 0}}(t))||r&&t&&"number"==typeof t.length){n&&(t=n);var i=0,o=function(){};return{s:o,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){c=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw a}}}}(o);try{for(c.s();!(s=c.n()).done;){var l=s.value;if(1==l.isdir){if(n&&a>=n)continue;await r(await t(l.path),a+1)}else i.push(l)}}catch(t){c.e(t)}finally{c.f()}}(await t(r),1),i}function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function o(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(void 0,o=function(t,e){if("object"!==n(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,"string");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(i.key),"symbol"===n(o)?o:String(o)),i)}var o}var a="accessToken";const s=function(){function e(t,r,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.appId=t,this.secret=r,this.refreshToken=n,this.headers={"User-Agent":"netdisk"}}var n,s;return n=e,(s=[{key:"_doRequest",value:async function(e,r){for(var n=0;n<3;n++){r.access_token=await this._refreshAccessToken(this.refreshToken);var i=Object.keys(r).map((function(t){return"".concat(t,"=").concat(r[t])})).join("&"),o=await fetch("".concat("https://pan.baidu.com/rest/2.0").concat(e,"?").concat(i),{headers:this.headers}),s=await o.json();if(0!=s.errno){if([111,-6].includes(s.errno)){t.storage.remove(a);continue}throw new Error("接口调用失败，path="+e+", errno="+s.errno)}return s}}},{key:"getFileList",value:async function(t){return await r(this._doGetList.bind(this),t,2)}},{key:"_doGetList",value:async function(t){for(var e=0,r={method:"list",dir:t,web:"web",order:"name"},n=[];;){r.start=e,r.limit=200,e+=200;var o=await this._doRequest("/xpan/file",r);if(0==o.list.length)break;n.push.apply(n,function(t){if(Array.isArray(t))return i(t)}(a=o.list.map((function(t){return t.path=encodeURIComponent(t.path),t})))||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(a)||function(t,e){if(t){if("string"==typeof t)return i(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}}(a)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}())}var a;return n}},{key:"_refreshAccessToken",value:async function(e){var r=t.storage.get(a);if(!r){var n=await fetch("https://openapi.baidu.com/oauth/2.0/token?grant_type=refresh_token&refresh_token=".concat(e,"&client_id=iYCeC9g08h5vuP9UqvPHKKSVrKFXGa1v&client_secret=jXiFMOPVPCWlO2M5CwWQzffpNPaGTRBG"));r=(await n.json()).access_token,t.storage.set(a,r)}return r}},{key:"getDlink",value:async function(t){var e={method:"filemetas",fsids:"[".concat(t,"]"),dlink:1},r=await this._doRequest("/xpan/multimedia",e);return"".concat(r.list[0].dlink,"&access_token=").concat(await this._refreshAccessToken(this.refreshToken))}}])&&o(n.prototype,s),Object.defineProperty(n,"prototype",{writable:!1}),e}();function c(t){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c(t)}function l(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,(void 0,i=function(t,e){if("object"!==c(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(n.key),"symbol"===c(i)?i:String(i)),n)}var i}var u="https://pan.baidu.com";const f=function(){function t(e,r,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.surl=e,this.pwd=r,this.headers={"User-Agent":"netdisk",Cookie:"BDUSS=".concat(n,"; ndut_fmt="),Referer:"https://pan.baidu.com/disk/home"}}var e,n;return e=t,(n=[{key:"getShareInfo",value:async function(){var t=await fetch("".concat(u,"/share/wxlist?channel=weixin&version=2.2.2&clienttype=25&web=1"),{method:"POST",headers:this.headers,body:"pwd=".concat(this.pwd,"&shorturl=").concat(this.surl,"&root=1")}),e=await t.json();if(0!=e.errno)throw new Error("获取分享信息失败，errno="+e.errno);return e.data}},{key:"getFileList",value:async function(){return await r(this._doGetList.bind(this),"")}},{key:"getDlink",value:async function(t){var e=await this.getShareInfo(),r=e.uk,n=e.shareid,i=e.seckey,o=await fetch("".concat(u,"/share/tplconfig?fields=sign,timestamp&channel=chunlei&web=1&app_id=250528&clienttype=0&surl=").concat(this.surl),{headers:this.headers}),a=await o.json();if(0!=a.errno)throw new Error("获取签名失败，errno="+a.errno);var s=a.data,c=s.sign,l=s.timestamp,f=await fetch("".concat(u,"/api/sharedownload?app_id=250528&channel=chunlei&clienttype=12&web=1&sign=").concat(c,"&timestamp=").concat(l),{method:"POST",headers:this.headers,body:'encrypt=0&extra={"sekey":"'.concat(i,'"}&fid_list=[').concat(t,"]&primaryid=").concat(n,"&product=share&type=nolimit&uk=").concat(r)}),p=await f.json();if(0!=p.errno)throw new Error("获取下载链接失败，errno="+p.errno);return p.list[0].dlink}},{key:"_doGetList",value:async function(t){for(var e=""===t?1:0,r=1,n=!0,i=[];n;){var o=await this._doGetPageList(t,e,r);i=i.concat(o.list),n=o.has_more,r++}return i}},{key:"_doGetPageList",value:async function(t,e,r){var n=await fetch("https://pan.baidu.com/share/wxlist?channel=weixin&version=2.2.2&clienttype=25&web=1",{method:"POST",headers:this.headers,body:"dir=".concat(t,"&num=1000&order=time&page=").concat(r,"&pwd=").concat(this.pwd,"&root=").concat(e,"&shorturl=").concat(this.surl)}),i=await n.json();if(0!=i.errno)throw new Error("解析文件列表失败，errno="+i.errno);return i.data}}])&&l(e.prototype,n),Object.defineProperty(e,"prototype",{writable:!1}),t}();function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function y(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function h(t,e,r){return(e=function(t){var e=function(t,e){if("object"!==p(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,"string");if("object"!==p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"===p(e)?e:String(e)}(e))in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}t.events.onResolve((async function(e){if(e.req.url.includes("pan.baidu.com/disk/main")){var r=new URL(e.req.url).hash.match(/path=(.*)/);if(!r)return;var n=r[1],i=decodeURIComponent(n).split("/").pop()||"全部文件",o=new s(t.settings.clientId,t.settings.clientSecret,t.settings.refreshToken),a=await o.getFileList(n);t.logger.debug("fileList",JSON.stringify(a)),e.res={name:i,files:a.map((function(e){var r;return{name:e.server_filename,size:e.size,path:decodeURIComponent(e.path.replace(n,"")).split("/").slice(1,-1).join("/"),req:{url:"http://d.pcs.baidu.com/file/".concat(e.fs_id),extra:{header:{"User-Agent":"pan.baidu.com"}},labels:(r={},h(r,t.info.identity,"1"),h(r,"fid",e.fs_id),h(r,"notShare","1"),r)}}}))}}else if(e.req.url.includes("pan.baidu.com/s/")){var c=new URL(e.req.url),l=c.pathname.split("/")[2],u=c.search,p="";if(u){var d=u.replace("?","").split("&").filter((function(t){var e,r,n=(e=t.split("="),r=2,function(t){if(Array.isArray(t))return t}(e)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,i,o,a,s=[],c=!0,l=!1;try{if(o=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(s.push(n.value),s.length!==e);c=!0);}catch(t){l=!0,i=t}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(l)throw i}}return s}}(e,r)||function(t,e){if(t){if("string"==typeof t)return y(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?y(t,e):void 0}}(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),i=n[0],o=n[1];if("pwd"===i)return o}));d.length>0&&(p=d[0])}if(t.logger.debug("match",l,p),!l)return;var m=new f(l,p,t.settings.bduss),b=await m.getShareInfo(),v=b.title.split("/").pop()+(b.list.length>1?"等":""),w=b.title.split("/").slice(0,-1).join("/")+"/",g=await m.getFileList();t.logger.debug("fileList",JSON.stringify(g)),e.res={name:v,files:g.map((function(r){var n;return{name:r.server_filename,size:r.size,path:r.path.replace(w,"").split("/").slice(0,-1).join("/"),req:{url:r.dlink,extra:{header:{"User-Agent":"pan.baidu.com"}},labels:(n={},h(n,t.info.identity,"1"),h(n,"rawUrl",e.req.url),h(n,"surl",l),h(n,"pwd",p),h(n,"fid",r.fs_id),n)}}}))}}})),t.events.onStart((async function(e){var r=e.task.meta.req;if(!r.labels.gotDlink||"error"==e.task.status){var n=r.labels.fid,i=r.url;if(r.labels.notShare){var o=new s(t.settings.clientId,t.settings.clientSecret,t.settings.refreshToken);i=await o.getDlink(n)}else{var a=r.labels.surl,c=r.labels.pwd,l=new f(a,c,t.settings.bduss);i=await l.getDlink(n)}t.logger.info("dlink",i),r.url=i,r.labels.gotDlink="1"}}))})();